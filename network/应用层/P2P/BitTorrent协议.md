### 简介
- 用于[[文件分发]]的P2P协议

##### 洪流
- torrent
- 参与一个文件发送的所有对等方的集合
##### 块
- chunk
- 一个[[#洪流]]中的对等方彼此下载等长度的文件块
- 典型的长度256KB
##### 过程
- 当一个对等方首次加入一个[[#洪流]]时，它没有[[#块]]
- 对等方下载块（积累越来越多的文件块）的同时也在上载块
- 当该对等方下载完整个文件时，它可以选择自主离开洪流，也可以选择留在[[#洪流]]中继续向其他对等方上载块
- 当该对等方没有完成整个文件的接收（即仅接收到部分文件块），也可以离开[[#洪流]]，以后也可以重新加入[[#洪流]]

### 工作过程
- 仅展示核心机制（一报还一报）
- 其他机制：片（小块）、流水线、随机优先选择、残局模型、反怠慢，不讨论
- 当一个对等方加入某[[#洪流]]时，需要向该洪流的[[#追踪器]]注册自己
- 对等方周期性的通知追踪器，它仍在洪流中
- 追踪器跟踪正在参与洪流的对等方
##### 追踪器
- tracker
- 每个洪流都有的一个基础设施节点
- 用于注册对等方
- 跟踪正在参与洪流的对等方

##### 一报还一报
- 具体场景
- Alice首次加入一个洪流
- [[#追踪器]]随机选择所有对等方的一个子集（如：50个），并将50个对等方的IP地址发送给Alice
- Alice持有对等方地址表，并尝试与该表中的对等方创建并行的TCP连接
- 成功创建TCP连接的对等方称为**邻近对等方**
- Alice的邻近对等方会出现波动，有些会离开，有些新的会加入
- 任意给定时间，每个对等方拥有不同的文件块列表
- Alice周期性的询问每个邻近对等方所拥有的的文件块列表（L个邻近，则获得L个块列表）
- Alice通过得到这个列表和自己拥有的块列表，可以的决定：
	1. 她要向哪些邻近对等方请求哪些**自己没有的**块
		- 使用**最稀缺优先（rarest first）**的算法
		- 针对邻居中副本数量最少的块（最稀缺），首先请求
		- 最稀缺的块优先被分发，使每个块更均匀地分布在[[#洪流]]中
	2. 她要向哪些邻近对等方发送哪些**邻居没有的**块
		- 使用一种对换算法，**一报还一报（fit-to-fat）**
		- 如果当前某个邻居能以**最高速率给她提供数据**，则优先发送数据给该邻居
		- Alice对每个邻居持续测量接收到bit的速率
		- 确定最高流入速率的4个邻居（4个对等方被称为**疏通（unchoked）**）
		- 每过10秒，重新计算速率，并修改这4个邻居
		- 每过30秒，她要随机选择另一个邻近对等方（称为Bob）向其发送块
		- 此时Bob的前4为上载者可能是Alice，Bob也开始向Alice上载数据
		- 如果Bob向Alice上载数据的速率足够高，则Bob也成为Alice的前4位上载者
		- Alice和Bob持续交换数据
		-   总结：
			1. 每过30秒，Alice随机选择一个伴侣并与其交换数据，如果两人满足交换，则将其放入前4名持续交换，直到其中之一发现更好的伴侣
			2. 对等方趋于寻找彼此协调的速率上载
			3. 随机的选择，新的对等方也有机会得到块
			4. 除了前4和试探对等方，其他的邻居对等方不能从Alice得到块，都被阻塞