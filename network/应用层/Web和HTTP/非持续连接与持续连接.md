### 非持续连接与持续连接
- 网络应用程序的设计中，对具体如何设计，如果是使用TCP作为运输层协议的话则要考虑每个请求和响应应如何使用TCP的连接
- **非持续连接（non-persistent connection）**：每个HTTP请求是经过一个**单独**的TCP连接发送
- **持续连接（persistent connection）**：所有的请求和响应经过**相同**的TCP连接发送
- HTTP两种情况都可以。默认使用持续连接，也可配置成非持续的

### HTTP非持续连接
##### 请求响应过程
- 当浏览器请求一个Web页面（1个HTTP基本页面和10个jpg图片）发生了什么：
	1. HTTP客户进程在80端口发起一个到服务器www.some.com的TCP连接，客户和服务器上分别有一个套接字与该TCP连接相关联
	2. HTTP客户端经他的套接字向服务器发送一个HTTP请求报文。路径名为/path/to/index.html
	3. HTTP服务器经它的套接字接收到请求报文，从存储器检索到index.html。在HTTP响应中封装该对象，通过套接字发送响应报文
	4. HTTP服务器进程通知TCP断开该TCP连接
	5. HTTP客户接收响应报文，TCP连接关闭。客户从响应报文中提取该文件，检查文件后得到10个jpg图片的引用
	6. 对每个引用重复前4个步骤
##### 对Web页面的展示
- 如何展示该页面，不同浏览器可能有不同方式解释展示，但**不属于**HTTP协议的定义范围
- 见[[现代浏览器内部揭秘]]
##### TCP连接个数
- 上述过程一个请求/响应对只使用一个TCP连接，所以一共产生11个tcp连接

##### TCP连接的串行和并行
- 上述过程关于jpg图片的请求可能是一个接一个TCP连接建立并请求和响应，即**串行**，也有可能是同时有几个TCP连接建立并请求和响应，即**并行**
- 浏览器可以配置该并行数，一般默认为5-10个并行TCP连接。若设置最大并行数为1，则是串行建立TCP连接
	**Chrome浏览器来说，同域名下资源加载的最大并发连接数为6，当资源文件大于6时，多于6个的文件就会进入待定，等第一批加载完才会加载第二批的6个图片资源**
##### 更详尽的一次请求过程
- 上述过程中的一次请求分为：TCP连接阶段（涉及“三次握手”过程）、HTTP请求和响应阶段
	更详细的过程：
	1. 客户向服务器发送一个小TCP报文段，
	2. 服务器用一个小TCP报文段做出确认和响应
	3. 客户向服务器返回确认，同时向该TCP连接发送一个HTTP请求报文
	4. 请求到达服务器，服务器就在该TCP连接上发送HTML文件
##### 一次请求所用的[[#RTT]]
- 前两次握手占用一个[[#RTT]]，最后一次握手加HTTP请求和响应占用一个[[#RTT]]
- 总响应时间约等于：2个[[#RTT]] + 服务器传输HTML文件的时间
##### 缺点
- 必须为**每一个请求的对象**建立和维护一个全新的连接，客户和服务器都要分配TCP的缓冲区和保持TCP变量，在大量客户同时请求时，给服务器带来严重的负担
- 每个对象经过2倍的RTT的时延

### HTTP持续连接
##### HTTP1.1的方式
- 服务器发送响应后保持TCP连接打开
- 相同的客户和服务器之间，后续请求和响应都通过相同的连接传送
- 一个完整Web页面可以使用单个持续TCP连接传送
- 有时多个Web页面由服务器发送给同一个客户也可以使用单个持续TCP连接传送
- 可以对对象的请求不必等待未决请求（流水线）的回答
- 一条连接超过一定时间（可配置的超时时间）没有使用，则HTTP服务器关闭该连接
- 默认使用带流水线的持续连接

##### HTTP/2
- [ RFC 7540 ]
- 建立在HTTP1.1基础上
- 允许在相同TCP连接上交错进行多个请求和回答
- 优化TCP连接中HTTP报文请求和回答机制

### RTT
- 往返时间（Round-Trip Time）
- 指一个短分组从客户到服务器，然后再返回客户所花的时间
- 包括分组传播时延、排队时延、处理时延等（见[[时延和丢包]]）