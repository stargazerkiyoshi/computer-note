### 分发大文件
- 考虑由服务器为大量用户主机（对等方）分发大文件
- [[网络应用程序体系结构#客户-服务器体系结构|客户-服务器体系结构]]中，服务器向每个对等方发送文件副本
- 消耗大量带宽

### P2P文件分发
- 每个对等方能重新分发它所拥有的该文件的任意部分
- 协助该服务器
- 最流行的协议[[BitTorrent协议]]
- 有许多BitTorrent的客户端

### 自扩展性
##### 场景模型
- 将一个文件分发给一个固定集合
- 服务器和对等方通过接入链路与Internet相连
- $u_s$：服务器接入链路的上载速率
- $d_i$：第i个对等方接入链路的下载速率
- $F$：被分发的文件长度（bit）
- $N$：要获得文件的对等方的数量
- 假设：
	1. internet核心有足够的带宽，即瓶颈出现在接入链路上
	2. 服务器和客户上没有其他网络应用，即所有上行、下行带宽都用在分发文件上
![[文件分发问题.png]]
##### 分发时间
- distribution time
- 所有N个对等方都获得完该文件的副本所需要的时间


##### 确定分发时间
###### 客户-服务器体系结构下的分发时间
- [[网络应用程序体系结构#客户-服务器体系结构]]
- 没有对等方参与分发文件
- 设[[#分发时间]]：$D_{cs}$
- 此时发生：
	1. 服务器最大发送时间$t_{maxsend}$：服务器向每个对等方发送文件副本，共$FN$bit。服务器接入链路上载速率为$u_s$，所以服务器传输完成时，至少耗时$FN/u_s$。
		即：最小分发时间$\geq FN/u_s$
	2. 对等方接收时间$t_{irecieve}$：第$i$个对等方的接收服务器发送来的文件副本，共$F$bit，接入链路下载速率为$d_i$，所以接收至少耗时$F/d_i$
		即：$t_{irecieve} \geq F/d_i$
	3. 对等方最小下载速率$d_{min}$：$min(d_1,d_2,\cdots,d_N)$
	4. 对等方最大接收时间$t_{maxrecieve}$：$\geq max(F/d_1,F/d_2,\cdots,F/d_N) = F/min(d_1,d_2,\cdots,d_N) = F/d_{min}$
		即：最小分发时间$\geq F/d_{min}$
	5. 综上：分发时间取服务器最大发送时间与对等方最大接收时间的多者。
		即：最小分发时间$D_{cs} \geq max(FN/u_s, F/d_{min})$
- 取实际最小分发时间：$D_{cs} = max(FN/u_s, F/d_{min})$
- 当$N$很大，$D_{cs}$由$FN/u_s$决定，线性增长
###### P2P体系结构下的分发时间
- [[网络应用程序体系结构#P2P体系结构]]
- 对等方参与分发文件
- 对等方将自己收到的部分文件数据分发到其他对等方
- 设[[#分发时间]]：$D_{p2p}$
- 此时发生：
	1. 服务器最大发送时间$t_{maxsend}$：服务器必须至少发送一次完整的文件副本，一个对等方收到的文件副本可以是其他对等方发送的，所以发送至少耗时$F/u_s$
		即：最小分发时间$\geq F/u_s$
	2. 对等方最小下载速率$d_{min}$：$min(d_1,d_2,\cdots,d_N)$
	3. 对等方最大接收时间$t_{maxrecieve}$：$\geq F/d_{min}$
	    即：最小分发时间$\geq F/u_s$
	4. 系统总体上载速率$u_{total}$：服务器和所有对等方上载速率之和$u_{total} = u_s + u_1 + u_2 + \cdots + u_N$。
	5. 系统总共交付bit数$FN$：向每个对等方发送一个文件副本
	6. 系统总最小分发时间：$\geq NF/(u_s + u_1 + \cdots + u_N)$
	7. 综上：最小分发时间：$D_{p2p} \geq max(FN/u_s, F/d_{min}, NF/(u_s + \sum\limits_{i=0}^N u_i))$
- 当对等方接收到一个bit后立刻重新分发该bit，则可以取到上述公式下界
- 实际中不是bit，而是文件块
- 取实际最小分发时间：$D_{p2p} = max(FN/u_s, F/d_{min}, NF/(u_s + \sum\limits_{i=0}^N u_i))$

##### 比较两种结构下的最小分发时间
- 假设：
	1. 所有对等方上载速率都为$u$
	2. $F/u = 1 h$ (h为小时)，即一小时的时间，对等方能分发完整个文件副本
	3. $u_s = 10u$，即服务器的上载速率是对等方的10倍
	4. $d_{min} \geq u_s$，即对等方的下载速率大于服务器的上传速率，不会有阻塞等影响（简化过程）
- 则：如图所示
	![[两种结构分发时间对比.png]]
- [[#客户-服务器体系结构下的分发时间]]，随对等方数量N增加而线性增长，且没有上界
- [[#P2P体系结构下的分发时间]]，总是小于[[#客户-服务器体系结构下的分发时间]]，且对任意数量N，总是小于1小时
- 所以P2P有自扩展性
##### 自扩展性的原因
- 对等方会重新分发文件


	